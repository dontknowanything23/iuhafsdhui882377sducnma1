
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>CarnotCallbacks_CONFblocks handles the parameters of _CONF blocks</title><meta name="generator" content="MATLAB 9.13"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2025-03-20"><meta name="DC.source" content="CarnotCallbacks_CONFblocks.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>CarnotCallbacks_CONFblocks handles the parameters of _CONF blocks</h1><!--introduction--><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Function Call</a></li><li><a href="#2">Inputs</a></li><li><a href="#3">Outputs</a></li><li><a href="#4">Description</a></li><li><a href="#5">References and Literature</a></li><li><a href="#6">function UserEdit enables editing of parameters, filename and pathname</a></li><li><a href="#7">function SaveFilename opens a user interface to save a parameter set</a></li><li><a href="#8">function GetFilename opens a user interface to choose a filename</a></li><li><a href="#9">function SetParameters loads the parameterfile and set parameters to the block in bhandle</a></li><li><a href="#10">function SetParameterFile set the parameter file to the respective CONF blocks</a></li><li><a href="#11">Copyright and Versions</a></li></ul></div><h2 id="1">Function Call</h2><pre>varargout = CarnotCallbacks_CONFblocks(fname, bhandle, varinputs)</pre><h2 id="2">Inputs</h2><pre>the input parameters depend on the function name
if fname is 'UserEdit' :
     CarnotCallbacks_CONFblocks(fname, bhandle, [uPath, uPara, fiName])
if fname is 'GetFilename':
     CarnotCallbacks_CONFblocks(fname, bhandle, folder, blockpath, ...
         [uPath, uPara, pName, fiName])
if fname is 'SaveFilename': varinputs are
     CarnotCallbacks_CONFblocks(fname, bhandle, folder, variableName, ...
         blockpath, [uPath, uPara, pName, fiName])
if fname is 'SetParameters':
     CarnotCallbacks_CONFblocks(fname, bhandle, pathname, filename, blockpath)
if fname is 'SetParameterFile':
     CarnotCallbacks_CONFblocks(fname, bhandle, fiName, CONFblock)</pre><pre>fname     : function name for the callback:
     'UserEdit' - disable / enable editing of filename+pathname or parameters
     'GetFilename' - get the filename and pathname, set these variables
                     in the mask
     'SaveFilename' - save parameter set with new filename and pathname
     'SetParameters' - load parameterfile and set parameters
     'SetParameterFile' - Set the parameter file to respective lower level
                         block from uppper mask
bhandle   : block handle (result of matlab function gcbh)
folder    : 'public' for public blocks, 'internal' for internal ones
variableName: name of the parameter variable in the .mat file
           The parameters are saved in a structure.
                 &lt;variableName&gt;.ParameterName1
                 &lt;variableName&gt;.ParameterName2
           (Remark: variableName is also used as a suggestion for a new filename)
pathname : path to the parameter file
           Use 'current' if the parameter file is in the current
           working directory.
filename : name of the parameter file
blockpath: path to the parameter files (*.mat) of the block relative to
           result of path_carnot('libsl') for blocks in the public folder
           or path_carnot('intlibsl')for blocks in the internal folder
           example:
           fullfile('Source','Solar_Thermal', 'SolarCollector','parameter_set')
CONFblock:  name of the block</pre><pre>optional parameters in brackets []:
 uPath : variable which enables the editing of path an filename
         default: 'userPath'
 uPara : variable which activates the editing of the parameters
         default: 'userParam'
 pName : variable which contains path name
         default: 'PathName'
 fiName : variable which contains the parameter file (mat-file)
         default: 'FileName'</pre><h2 id="3">Outputs</h2><pre>ok - true, if loading and setting of params was successfull
paramStruct - strucutre with the parameter set</pre><h2 id="4">Description</h2><pre>Search for the parameter set in the public and internal folders
Blockname\parameter_set and load the parameter set. The pathname can be
set to 'current'. In this case the block searches the parameter set only
in the current directory.
When using this file as a template: The two parameters before
'userPath' are interpreted as pathname and filename. All parameters
after 'userParam' are interpeted as part of the parameter set.
See Collector_Unglazed_CONF block in Carnot for the settings of the mask.
Get their names and values with:
       mnames = get_param(bhandle,'MaskNames');
       mvalues = get_param(bhandle,'MaskValues');
       idx = find(strcmp(mnames,'userParam'))+1;
       for i = idx:length(mnames)
           s = [variableName '.' mnames{i} ' = ' mvalues{i} ';'];
           eval(s)
       end</pre><h2 id="5">References and Literature</h2><pre>Function is used by: Mask of CONF blocks in Carnot
see also CarnotCallbacks_CollectorUnglazedConf, CarnotCallbacks_HouseSimple,
         BlockIsInCarnotLibrary</pre><h2 id="6">function UserEdit enables editing of parameters, filename and pathname</h2><h2 id="7">function SaveFilename opens a user interface to save a parameter set</h2><h2 id="8">function GetFilename opens a user interface to choose a filename</h2><h2 id="9">function SetParameters loads the parameterfile and set parameters to the block in bhandle</h2><h2 id="10">function SetParameterFile set the parameter file to the respective CONF blocks</h2><h2 id="11">Copyright and Versions</h2><pre>This file is part of the CARNOT Blockset.
Copyright (c) 1998-2024, Solar-Institute Juelich of the FH Aachen.
Additional Copyright for this file see list auf authors.
All rights reserved.
Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:
1. Redistributions of source code must retain the above copyright notice,
  this list of conditions and the following disclaimer.
2. Redistributions in binary form must reproduce the above copyright
  notice, this list of conditions and the following disclaimer in the
  documentation and/or other materials provided with the distribution.
3. Neither the name of the copyright holder nor the names of its
  contributors may be used to endorse or promote products derived from
  this software without specific prior written permission.
THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
THE POSSIBILITY OF SUCH DAMAGE.</pre><pre>************************************************************************
VERSIONS
author list:     hf -&gt; Bernd Hafner
                 ptia -&gt; Amruta Patil
version: CarnotVersion.MajorVersionOfFunction.SubversionOfFunction
Version  Author  Changes                                         Date
6.1.0    hf      created                                         27dec2017
6.1.1    hf      choicedlg in SetParameters when file or path    11jan2018
                 is wrong
6.1.2    hf      set file to emtpy string in SaveFilename        18feb2018
6.1.3    hf      save on internal path: path is fullfile(...)    18dec2018
6.1.4    hf      load button doesn't overwrite 'fullfile()' path 20dec2018
6.1.5    hf      path 'current': current working directory only  30dec2018
6.1.6    PtiA    added new function (setParameterFile)           23sep2020
                 updated all other functions such that they work
                 for the existing and new CONF models
                 (especially system models)
6.1.7    hf      function SaveFilename:                          27dec2020
                     userPath instead of UserPath
                     userParam instead of UserParam
7.1.0    hf      all functions 'userPath' instead of 'UserPath'  10mar2021
                               'userParam' instead of 'UserParam'
8.1.0    hf      added comments and description                  01sep2022
                 commented out: disp('loading parameter set ...')
8.1.1    hf      set_param of cell arrays with double ''         20jun2023
8.1.2    hf      SetParameterFile: check if filename has '       26jun2023
8.1.3    hf      SaveFilename: replaced eval, new version is     22dec2023
                 with replace(mvalues{i}, '''', '''''')
*************************************************************************</pre><p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2022b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% CarnotCallbacks_CONFblocks handles the parameters of _CONF blocks
%% Function Call
%  varargout = CarnotCallbacks_CONFblocks(fname, bhandle, varinputs)
%% Inputs   
%  the input parameters depend on the function name
%  if fname is 'UserEdit' : 
%       CarnotCallbacks_CONFblocks(fname, bhandle, [uPath, uPara, fiName])
%  if fname is 'GetFilename':
%       CarnotCallbacks_CONFblocks(fname, bhandle, folder, blockpath, ...
%           [uPath, uPara, pName, fiName])
%  if fname is 'SaveFilename': varinputs are
%       CarnotCallbacks_CONFblocks(fname, bhandle, folder, variableName, ...
%           blockpath, [uPath, uPara, pName, fiName])
%  if fname is 'SetParameters': 
%       CarnotCallbacks_CONFblocks(fname, bhandle, pathname, filename, blockpath)
%  if fname is 'SetParameterFile': 
%       CarnotCallbacks_CONFblocks(fname, bhandle, fiName, CONFblock)
% 
%  fname     : function name for the callback:
%       'UserEdit' - disable / enable editing of filename+pathname or parameters
%       'GetFilename' - get the filename and pathname, set these variables 
%                       in the mask
%       'SaveFilename' - save parameter set with new filename and pathname
%       'SetParameters' - load parameterfile and set parameters
%       'SetParameterFile' - Set the parameter file to respective lower level 
%                           block from uppper mask
%  bhandle   : block handle (result of matlab function gcbh)
%  folder    : 'public' for public blocks, 'internal' for internal ones
%  variableName: name of the parameter variable in the .mat file
%             The parameters are saved in a structure.
%                   <variableName>.ParameterName1
%                   <variableName>.ParameterName2
%             (Remark: variableName is also used as a suggestion for a new filename)
%  pathname : path to the parameter file
%             Use 'current' if the parameter file is in the current
%             working directory.
%  filename : name of the parameter file
%  blockpath: path to the parameter files (*.mat) of the block relative to
%             result of path_carnot('libsl') for blocks in the public folder 
%             or path_carnot('intlibsl')for blocks in the internal folder
%             example: 
%             fullfile('Source','Solar_Thermal', 'SolarCollector','parameter_set')
%  CONFblock:  name of the block
% 
%  optional parameters in brackets []:
%   uPath : variable which enables the editing of path an filename
%           default: 'userPath'
%   uPara : variable which activates the editing of the parameters
%           default: 'userParam'
%   pName : variable which contains path name 
%           default: 'PathName'
%   fiName : variable which contains the parameter file (mat-file)
%           default: 'FileName'
% 
%
%% Outputs
%  ok - true, if loading and setting of params was successfull
%  paramStruct - strucutre with the parameter set
% 
%% Description
%  Search for the parameter set in the public and internal folders 
%  Blockname\parameter_set and load the parameter set. The pathname can be
%  set to 'current'. In this case the block searches the parameter set only
%  in the current directory.
%  When using this file as a template: The two parameters before
%  'userPath' are interpreted as pathname and filename. All parameters 
%  after 'userParam' are interpeted as part of the parameter set. 
%  See Collector_Unglazed_CONF block in Carnot for the settings of the mask.
%  Get their names and values with:
%         mnames = get_param(bhandle,'MaskNames');
%         mvalues = get_param(bhandle,'MaskValues');
%         idx = find(strcmp(mnames,'userParam'))+1;
%         for i = idx:length(mnames)
%             s = [variableName '.' mnames{i} ' = ' mvalues{i} ';'];
%             eval(s)
%         end
% 
%% References and Literature
%  Function is used by: Mask of CONF blocks in Carnot
%  see also CarnotCallbacks_CollectorUnglazedConf, CarnotCallbacks_HouseSimple, 
%           BlockIsInCarnotLibrary

function varargout = CarnotCallbacks_CONFblocks(varargin)
% Switch for command line calls
if nargin >= 1 && ischar(varargin{1})
    FunctionName = varargin{1};
    % Call the function
    if nargout > 0
        [varargout{1:nargout}] = feval(FunctionName, varargin{2:end});
    else
        feval(FunctionName, varargin{2:end});
    end
else
    error(['CarnotCallbacks_CONFblocks: First argument must be a valid ' ...
        'function name. Second argument must be the blockhandle.'])
end
end % function CarnotCallbacks_CONFblocks


%% function UserEdit enables editing of parameters, filename and pathname
function [ok, param] = UserEdit(bhandle,uPath,uPara,fiName)
%Check input arguments  
if nargin == 0
    error('Function UserEdit: Not enough input arguments');
elseif nargin < 4  
    % default CONF blocks function REPLACE_WITH_DASH_DASH> [ok, param] = UserEdit(bhandle)
    uPath = 'userPath';     % name of the variable enables the editing of path an filename
    uPara = 'userParam';    % name of the variable which activates the editing of the parameters
    fiName = 'FileName';  % name of the variable with the parameter-file (mat-file)
end
userpara = get_param(bhandle, uPara);       % changed hf 01/09/22
% userpara = get_param(bhandle, 'userParam');
userpath = get_param(bhandle, uPath);       % changed hf 01/09/22
% userpath = get_param(bhandle, 'userPath');
me = get_param(bhandle, 'MaskEnables');
% find the index to the parameter named 'userPath'
idx = find(strcmp(get_param(bhandle,'MaskNames'),uPath)); 
% the two parameters before 'userPath' are the pathname and filename
for i = idx-2:idx-1
    me{i} = userpath;
end
% find the index to the parameter named 'userParam'
idx = find(strcmp(get_param(bhandle,'MaskNames'),uPara)); 
% all parameters after "userParam" are part of the parameter set
for i = idx+1:length(me)
    me{i} = userpara;
end
set_param(bhandle, 'MaskEnables', me);
% change filename if user wants to edit the parameters
if strcmp(userpara, 'on')
    set_param(bhandle, fiName, mat2str('<user defined>'));
    param = 1;
else
    param = 0;
end
ok = true;
end


%% function SaveFilename opens a user interface to save a parameter set
function [ok, file] = SaveFilename(bhandle,folder,variableName,blockpath, ...
    uPath,uPara,pName,fiName) 
%Check input arguments  
if nargin == 0
    error('Function SaveFilename: Not enough input arguments');
elseif nargin < 8   
    % default CONF blocks function 
    % REPLACE_WITH_DASH_DASH> [ok, file] = SaveFilename(bhandle,folder,variableName,blockpath)
    uPath = 'userPath';
    uPara = 'userParam';
    pName = 'PathName';
    fiName = 'FileName';
end
userpara = get_param(bhandle, 'userParam');
file = '';          % default file name is an empty string
% set relative path in carnot to the block
if strcmp(userpara, 'on')
    pathname = get_param(bhandle, pName);
    if strcmp(folder, 'internal')
        pathname = mat2str(fullfile(path_carnot('intlibsl'),blockpath));
    end
    pname = eval(pathname);
    % change path if required
    oldpath = pwd;      % keep current (original) path
    if ~strcmp(pname,'current') % 'current' : user wants to keep current working directory
        % check if path exists
        if ~exist(pname, 'dir')
            ok = false;
            % Construct a questdlg with two options
            choice = questdlg('Directory does not exist! Create it?', ...
                'Not existing directory', 'Yes','No','No');
            if strcmp(choice,'Yes')
                % create a new directory
                [success,~,~] = mkdir(pname);
                if success > 0
                    ok = true;
                end
            end
        else
            ok = true;
        end
        if ~ok
            return
        end
        % change to new path
        cd(pname)        % change directory to working path
    end
    % choose a filename which is not yet used
    file = [variableName, '_set1.mat'];
    n = 1;
    while exist(file,'file')
        n = n+1;
        file = [variableName, '_set' num2str(n) '.mat'];
    end
    [file,pname2,ok] = uiputfile('*.mat', 'Save parameter set as', file);
    if ok
        set_param(bhandle, fiName, mat2str(file));
        if strcmp(folder, 'internal')
            s1 = 'fullfile(path_carnot(''intlibsl''), ''';
            s2 = strsplit(blockpath, filesep);
            for m = 1:length(s2)-1
                s1 = [s1, s2{m}, ''', ''']; %#ok<AGROW>
            end
            s1 = [s1, s2{end}, ''')'];
        else
            s1 = mat2str(pname2);
        end
        if ~strcmp(pname,'current')   % 'current' : user wants to select current path only
            set_param(bhandle, pName, s1);
        end
        % pack the parameters in a struct
        mnames = get_param(bhandle,'MaskNames');
        mvalues = get_param(bhandle,'MaskValues');
        % all parameters after "userParam" are part of the parameter set
        idx = find(strcmp(mnames,uPara))+1;
        for i = idx:length(mnames)
            try
                if ~isnan(str2double(mvalues{i}))
                    eval([variableName '.' mnames{i} ' = ' mvalues{i} ';'])
                else  % changed  hf,22dec2023
                    eval([variableName '.' mnames{i} ' = ''' ...
                        replace(mvalues{i}, '''', '''''') ''';'])
                % else
                    %eval([variableName '.' mnames{i} ' = ''' mvalues{i} ''';']) 
                end
            catch
                eval([variableName '.' mnames{i} ' = {' mvalues{i} '};']) %KteA
            end
        end
        % save parameter struct in the file
        eval(['save(file, ' mat2str(variableName) ')'])
        % turn off user editing
        set_param(bhandle, uPara, 'off');
        UserEdit(bhandle,uPath,uPara,fiName);
    end
    cd(oldpath)     % back to the original path
else
    ok = false;
    warndlg('User parameters is not active. Only user edited parameters can be saved.')
end % if
end % function SaveFilename


%% function GetFilename opens a user interface to choose a filename
function [ok, file] = GetFilename(bhandle,folder,blockpath,uPath,uPara,pName,fiName)
%Check input arguments  
if nargin == 0
    error('Function GetFilename: not enough input arguments');
elseif nargin < 7   
    % default CONF blocks function REPLACE_WITH_DASH_DASH> [ok, file] = GetFilename(bhandle,folder,blockpath)
    uPath = 'userPath';
    uPara = 'userParam';
    pName = 'PathName';
    fiName = 'FileName';
end
% set relative path in carnot to the block
userpara = get_param(bhandle, uPara);
file = '';          % default file name is an empty string
if strcmp(userpara, 'on')
    % Construct a questdlg with two options
    choice = questdlg('"User defined parameters" is active! Overwrite parameter values ?', ...
        'Choice of parameters', ...
        'Yes','No','No');
    if ~strcmp(choice,'Yes')
        ok = false;
        return
    end
    set_param(bhandle, uPara, 'off');
    UserEdit(bhandle,uPath,uPara,fiName);
end
switch folder
    case 'selected'
        pathname = get_param(bhandle, pName);
    case 'public'
        pathname = 'fullfile(path_carnot(''libsl''), ''';
        s2 = strsplit(blockpath, filesep);
        for m = 1:length(s2)-1
            pathname = [pathname, s2{m}, ''', ''']; %#ok<AGROW>
        end
        pathname = [pathname, s2{end}, ''')'];
    case 'internal'
        pathname = 'fullfile(path_carnot(''intlibsl''), ''';
        s2 = strsplit(blockpath, filesep);
        for m = 1:length(s2)-1
            pathname = [pathname, s2{m}, ''', ''']; %#ok<AGROW>
        end
        pathname = [pathname, s2{end}, ''')'];
    otherwise
        pathname = get_param(bhandle, pName);
end
pname = eval(pathname);
% change directory
oldpath = pwd;
if ~strcmp(pname,'current') % not 'current' : user selected current working directory only
    % check if path exists
    if ~exist(pname, 'dir')
        ok = false;
        warndlg('Path does not exist!');
        return
    end
    cd(pname)
end
filename = erase(get_param(bhandle, fiName),'''');
[filename,pname2,ok] = ...
    uigetfile({'*.mat';'*.dat';'*.txt';'*.csv';'*.*'}, ...
    'Pick a data file',filename);
cd(oldpath)
if ok
    set_param(bhandle, fiName, mat2str(filename));
    if ~strcmp(pname,'current')                     % not 'current' : user selected current working directory only
        if ~strcmpi(pname,pname2(1:end-1))          % if pathes are not the same
            pathname = mat2str(pname2(1:end-1));    % new path is one from uigetfile
        end
        set_param(bhandle, pName, pathname);   % set new path in mask
    end
    [~,~] = SetParameters(bhandle, pname2, filename, blockpath);
    file = fullfile(pathname,filename);
end
end % function GetFilename


%% function SetParameters loads the parameterfile and set parameters to the block in bhandle
function [ok, paramStruct] = SetParameters(bhandle,pathname,filename,blockpath)
%Check input arguments  
if nargin == 0
    error('Function SetParameters: Not enough input arguments');
end
ok = false;
paramStruct = [];
if ~BlockIsInCarnotLibrary
    if strcmp(pathname,'current')
        file = filename;
    else
        file = fullfile(pathname, filename);
    end
    s = get(bhandle);
    if strcmp(filename, '<user defined>')
        return
    elseif exist(file,'file')
        paramStruct = importdata(file);
        ok = true;
    else
        choice = questdlg({['Block ' s.Path, '/',s.Name]; ...
            ['Parameter set: ', file]; 'not found.'}, 'File not found', ...
            'Use previous values','Load from Carnot public data', ...
            'Load from Carnot internal data','Use previous values');
        % Handle response
        switch choice
            case 'Use previous values'
                return
            case 'Load from Carnot internal data'
                [ok, file] = GetFilename(bhandle,'internal',blockpath);
            case 'Load from Carnot public data'
                [ok, file] = GetFilename(bhandle,'public',blockpath);
        end
        paramStruct = importdata(file);
    end
    paraNames = fieldnames(paramStruct);    % get parameter names
    % Get block properties
    maskNames = get_param(bhandle, 'MaskNames');
    for k = 1:length(maskNames)
        for l = 1:length(paraNames)
            if strcmp(maskNames{k},paraNames{l})
                if ischar(paramStruct.(paraNames{l})) % parameter is already char
                    set_param(bhandle, maskNames{k}, ...
                        paramStruct.(paraNames{l}));
                elseif iscell (paramStruct.(paraNames{l})) 
                    % disp('CarnotCallbacks_CONFblocks - SetParameters : parameter is cell')
                    % set_param(bhandle, maskNames{k}, ...
                    %    cell2mat(paramStruct.(paraNames{l})));
                    % modified hf 20jun2023
                    set_param(bhandle, maskNames{k}, ...
                        mat2str(cell2mat(paramStruct.(paraNames{l}))));
                else
                    set_param(bhandle, maskNames{k}, ...
                        mat2str(paramStruct.(paraNames{l})));     
                end
            end
        end 
    end
end
end
% function SetParameters 

 
%% function SetParameterFile set the parameter file to the respective CONF blocks
function [ok,paramfile] = SetParameterFile(bhandle,fiName,CONFblock)  
% set parameterfile to respective CONF blocks automatically
% check input arguments  
if nargin == 0
    error('Function SetParameterFile: Not enough input arguments');
end  
sysIn = find_system(gcb);    % to get the root block path
CONFBlock = get_param(bhandle,CONFblock); % CONF model block name
% Combines the root block path with CONF model REPLACE_WITH_DASH_DASH> CONF block path
CONFblock_path = cell2mat(strcat(sysIn,'/',CONFBlock));  
filename = get_param(bhandle,fiName); 
% detect if filename already contains ' or "
if ~strcmp(filename(1), '''') && ~strcmp(filename(1), '"')
    filename = mat2str(filename); % if this is not the case, convert to string
end
set_param (CONFblock_path,'FileName',filename); % set the parameter file to respective CONF block
ok = 1;
paramfile = 1;
end
% function SetParameterFile
 
%% Copyright and Versions
%  This file is part of the CARNOT Blockset.
%  Copyright (c) 1998-2024, Solar-Institute Juelich of the FH Aachen.
%  Additional Copyright for this file see list auf authors.
%  All rights reserved.
%  Redistribution and use in source and binary forms, with or without 
%  modification, are permitted provided that the following conditions are 
%  met:
%  1. Redistributions of source code must retain the above copyright notice, 
%    this list of conditions and the following disclaimer.
%  2. Redistributions in binary form must reproduce the above copyright 
%    notice, this list of conditions and the following disclaimer in the 
%    documentation and/or other materials provided with the distribution.
%  3. Neither the name of the copyright holder nor the names of its 
%    contributors may be used to endorse or promote products derived from 
%    this software without specific prior written permission.
%  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" 
%  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE 
%  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE 
%  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE 
%  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR 
%  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF 
%  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS 
%  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN 
%  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) 
%  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF 
%  THE POSSIBILITY OF SUCH DAMAGE.
%  
%  ************************************************************************
%  VERSIONS
%  author list:     hf -> Bernd Hafner
%                   ptia -> Amruta Patil
%  version: CarnotVersion.MajorVersionOfFunction.SubversionOfFunction
%  Version  Author  Changes                                         Date
%  6.1.0    hf      created                                         27dec2017
%  6.1.1    hf      choicedlg in SetParameters when file or path    11jan2018
%                   is wrong
%  6.1.2    hf      set file to emtpy string in SaveFilename        18feb2018
%  6.1.3    hf      save on internal path: path is fullfile(...)    18dec2018
%  6.1.4    hf      load button doesn't overwrite 'fullfile()' path 20dec2018
%  6.1.5    hf      path 'current': current working directory only  30dec2018
%  6.1.6    PtiA    added new function (setParameterFile)           23sep2020
%                   updated all other functions such that they work 
%                   for the existing and new CONF models 
%                   (especially system models)
%  6.1.7    hf      function SaveFilename:                          27dec2020
%                       userPath instead of UserPath     
%                       userParam instead of UserParam
%  7.1.0    hf      all functions 'userPath' instead of 'UserPath'  10mar2021
%                                 'userParam' instead of 'UserParam'
%  8.1.0    hf      added comments and description                  01sep2022
%                   commented out: disp('loading parameter set ...')
%  8.1.1    hf      set_param of cell arrays with double ''         20jun2023
%  8.1.2    hf      SetParameterFile: check if filename has '       26jun2023
%  8.1.3    hf      SaveFilename: replaced eval, new version is     22dec2023
%                   with replace(mvalues{i}, '''', '''''')
% *************************************************************************

##### SOURCE END #####
--></body></html>